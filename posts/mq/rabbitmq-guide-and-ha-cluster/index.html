<!doctype html><html><head lang=zh><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>RabbitMQ-入门及高可用集群部署 - xiaoheiAh's blog</title><link rel=icon type=image/png href=https://blog.xiaohei.im/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="RabbitMQ-入门及高可用集群部署"><meta property="og:description" content="「RabbitMQ 学习笔记」| docker 部署"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.xiaohei.im/posts/mq/rabbitmq-guide-and-ha-cluster/"><meta property="article:published_time" content="2019-09-04T14:42:13+08:00"><meta property="article:modified_time" content="2019-09-04T14:42:13+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="RabbitMQ-入门及高可用集群部署"><meta name=twitter:description content="「RabbitMQ 学习笔记」| docker 部署"><link rel=stylesheet type=text/css media=screen href=https://blog.xiaohei.im/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://blog.xiaohei.im/css/main.css><link rel=stylesheet href="https://fonts.loli.net/css2?display=swap&family=Bitter&family=Noto%20Sans%20SC"><link rel=stylesheet type=text/css href=https://blog.xiaohei.im/css/dark.css media="(prefers-color-scheme: dark)"><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://blog.xiaohei.im/js/main.js></script></head><body><div class="container wrapper post"><div class=header><h1 class=site-title><a href=https://blog.xiaohei.im/>xiaoheiAh's blog</a></h1><div class=site-description><h2>Java Developer | 关注后端</h2><nav class="nav social"><ul class=flat><a href=https://github.com/xiaoheiAh title=xiaoheiAh><i data-feather=github></i></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li><li><a href=/awesome>Awesome</a></li><li><a href=/cheatsheet>CheatSheet</a></li><li><a href=/about>About</a></li></ul></nav></div><div class=post-header><h1 class=title>RabbitMQ-入门及高可用集群部署</h1><div class=meta style=display:inline>Posted at &mdash; Sep 4, 2019</div><div class=meta style=display:inline><a>Page Views: 6</a></div></div><div class=markdown><blockquote><p>rabbitmq version: 3.7.15</p></blockquote><h2 id=常用操作>常用操作</h2><ol><li><code>sbin/rabbitmq-server</code> 启动</li><li><code>sbin/rabbitmq-server -detached</code> 后台启动</li><li><code>sbin/rabbitmqctl shutdown/stop</code> 关闭/停止server</li><li><code>sbin/rabbitmqctl status</code> 检查server状态</li><li><code>sbin/rabbitmq-plugins enable rabbitmq_management</code> 开启控制台</li></ol><h2 id=端口>端口</h2><ol><li>server启动后默认监听<code>5672</code></li><li>控制台默认监听<code>15672</code></li></ol><h2 id=构建集群>构建集群</h2><h3 id=构建集群的方式>构建集群的方式</h3><ol><li>在<code>config</code>文件中声明节点信息</li><li>使用<code>DNS</code>发现</li><li>使用<code>AWS</code>实例发现(<strong>通过插件</strong>)</li><li>使用<code>kubernetes</code>发现(<strong>通过插件</strong>)</li><li>使用<code>consul</code>发现(<strong>通过插件</strong>)</li><li>使用<code>etcd</code>发现(<strong>通过插件</strong>)</li><li>手动执行<code>rabbitmqctl</code></li></ol><h3 id=节点名称>节点名称</h3><ul><li><p>节点名称是节点的身份识别证明.两部分组成: <code>prefix</code> & <code>hostname</code>.例如 <code>rabbit@node1.messaging.svc.local</code>的<code>prefix</code>是 <strong>rabbit</strong> ,<code>hostname</code>是 <strong>node1.messaging.svc.local</strong>.</p></li><li><p>集群中名称必须 <strong>唯一</strong>. 如果使用同一个<code>hostname</code> 那么<code>prefix</code>要保持不一致</p></li><li><p>集群中,节点通过节点名称互相进行识别和通信.所以<code>hostname</code>必须能解析.<code>CLI Tools</code>也要使用节点名称.</p></li></ul><h3 id=单机集群构建>单机集群构建</h3><p>单机运行多节点需要保证:</p><ul><li>不同节点名称 <code>RABBITMQ_NODENAME</code></li><li>不同存储路径 <code>RABBITMQ_DIST_PORT</code></li><li>不同日志路径 <code>RABBITMQ_LOG_BASE</code></li><li>不同端口,包括插件使用的 <code>RABBITMQ_NODE_PORT</code></li></ul><h4 id=rabbitmqctl-构建集群>rabbitmqctl 构建集群</h4><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#268bd2>RABBITMQ_NODE_PORT</span><span style=color:#719e07>=</span><span style=color:#2aa198>5672</span> <span style=color:#268bd2>RABBITMQ_NODENAME</span><span style=color:#719e07>=</span>rabbit rabbitmq-server -detached
<span style=color:#268bd2>RABBITMQ_NODE_PORT</span><span style=color:#719e07>=</span><span style=color:#2aa198>5673</span> <span style=color:#268bd2>RABBITMQ_NODENAME</span><span style=color:#719e07>=</span>hare rabbitmq-server -detached
<span style=color:#586e75># 重置正在运行的节点</span>
rabbitmqctl -n hare stop_app
<span style=color:#586e75># 加入集群</span>
rabbitmqctl -n hare join_cluster rabbit@<span style=color:#586e75>`</span>hostname -s<span style=color:#586e75>`</span>
rabbitmqctl -n hare start_app</code></pre></div><p>每个节点若配置有其他的插件.那么每个节点插件监听的端口不能冲突,例如添加控制台</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#586e75># 首先开启控制台插件</span>
./rabbitmq-plugins <span style=color:#b58900>enable</span>  rabbitmq_management
<span style=color:#268bd2>RABBITMQ_NODE_PORT</span><span style=color:#719e07>=</span><span style=color:#2aa198>5672</span> <span style=color:#268bd2>RABBITMQ_SERVER_START_ARGS</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;-rabbitmq_management listener [{port,15672}]&#34;</span> <span style=color:#268bd2>RABBITMQ_NODENAME</span><span style=color:#719e07>=</span>rabbit ./rabbitmq-server -detached
<span style=color:#268bd2>RABBITMQ_NODE_PORT</span><span style=color:#719e07>=</span><span style=color:#2aa198>5673</span> <span style=color:#268bd2>RABBITMQ_SERVER_START_ARGS</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;-rabbitmq_management listener [{port,15673}]&#34;</span> <span style=color:#268bd2>RABBITMQ_NODENAME</span><span style=color:#719e07>=</span>hare ./rabbitmq-server -detached

<span style=color:#586e75># 加入rabbit节点生成集群</span>
rabbitmqctl -n hare stop_app
<span style=color:#586e75># 加入集群</span>
rabbitmqctl -n hare join_cluster rabbit@<span style=color:#586e75>`</span>hostname -s<span style=color:#586e75>`</span>
rabbitmqctl -n hare start_app</code></pre></div><p>以上就建了带控制台的两个节点.</p><h4 id=遇到的问题>遇到的问题</h4><ol><li>添加节点进集群时,报错</li></ol><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./rabbitmqctl -n rabbit2 join_cluster rabbit@<span style=color:#586e75>`</span>hostname -s<span style=color:#586e75>`</span>

Clustering node rabbit2@localhost with rabbit@localhost
Error:
<span style=color:#719e07>{</span>:inconsistent_cluster, <span style=color:#2aa198>&#39;Node rabbit@localhost thinks it\&#39;</span>s clustered 	with node rabbit2@localhost, but rabbit2@localhost disagrees&#39;<span style=color:#719e07>}</span></code></pre></div><p>集群残留的<code>cluster</code>信息导致认证失败.删除<code>${RABBIT_MQ_HOME}/var/lib/rabbitmq/mnesia</code>文件夹.再<code>reset</code>节点</p><ol start=2><li>建集群报错</li></ol><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Clustering node rabbit2@localhost with rabbit@localhost
Error:
<span style=color:#719e07>{</span>:corrupt_or_missing_cluster_files, <span style=color:#719e07>{</span>:error, :enoent<span style=color:#719e07>}</span>, <span style=color:#719e07>{</span>:error, :enoent<span style=color:#719e07>}}</span></code></pre></div><p>同上</p><ol start=3><li>启动第三个节点时爆端口占用,该端口是第一个节点的控制台端口<code>15672</code>.<strong>没有解决</strong></li></ol><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>2019-09-05 15:35:42.749 <span style=color:#719e07>[</span>error<span style=color:#719e07>]</span> &lt;0.555.0&gt; Failed to start Ranch listener rabbit_web_dispatch_sup_15672 in ranch_tcp:listen<span style=color:#719e07>([{</span>cacerts,<span style=color:#2aa198>&#39;...&#39;</span><span style=color:#719e07>}</span>,<span style=color:#719e07>{</span>key,<span style=color:#2aa198>&#39;...&#39;</span><span style=color:#719e07>}</span>,<span style=color:#719e07>{</span>cert,<span style=color:#2aa198>&#39;...&#39;</span><span style=color:#719e07>}</span>,<span style=color:#719e07>{</span>port,15672<span style=color:#719e07>}])</span> <span style=color:#719e07>for</span> reason eaddrinuse <span style=color:#719e07>(</span>address already in use<span style=color:#719e07>)</span></code></pre></div><h2 id=使用案例>使用案例</h2><h4 id=topic-exchange>Topic Exchange</h4><p><code>topic</code>类型的<code>exchange</code> ,<code>routing key</code> 是按一定规则来的,通过<code>.</code>连接,类似于正则.有两种符号:</p><ul><li><code>*</code> 代表一个单词</li><li><code>#</code> 代表0或多个单词</li></ul><p>如果 单单只有<code>#</code>号, 那么<code>topic exchange</code>就像<code>fanout exchange</code>,如果没有使用<code>*</code>和<code>#</code>,那就是<code>direct exchange</code>了.</p><h2 id=参考>参考</h2><ol><li><a href=https://hub.docker.com/_/rabbitmq/>docker hub rabbit mq 镜像</a></li></ol></div><div class=post-tags><nav class="nav tags"><ul class=flat><li><a href=/tags/rabbitmq>rabbitmq</a></li></ul></nav></div><script src=https://utteranc.es/client.js repo=xiaoheiAh/xiaoheiAh.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div><div class="footer wrapper"><nav class=nav><div class=badge><img src=https://img.shields.io/badge/PV-6164-green alt=pv>
<img src=https://img.shields.io/badge/UV-1741-green alt=pv>
<img src="https://img.shields.io/badge/License-CC%20BY%20NC%20ND%204.0-green?link=http://creativecommons.org/licenses/by-nc-nd/4.0/" alt="CC BY NC ND 4.0">
<span>| © 2019 | <a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></span></div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-98254666-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></body></html>