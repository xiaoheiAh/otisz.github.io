<!doctype html><html><head lang=zh><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Redis-RDB持久化 - xiaoheiAh's blog</title><link rel=icon type=image/png href=https://blog.xiaohei.im/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Redis-RDB持久化"><meta property="og:description" content="「Redis 学习笔记」| 持久化机制 | RDB"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.xiaohei.im/posts/redis/rdb/"><meta property="article:published_time" content="2019-11-06T19:08:56+08:00"><meta property="article:modified_time" content="2019-11-06T19:08:56+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Redis-RDB持久化"><meta name=twitter:description content="「Redis 学习笔记」| 持久化机制 | RDB"><link rel=stylesheet type=text/css media=screen href=https://blog.xiaohei.im/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://blog.xiaohei.im/css/main.css><link rel=stylesheet type=text/css href=https://blog.xiaohei.im/css/custom.css><link rel=stylesheet type=text/css href=https://blog.xiaohei.im/css/dark.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=https://blog.xiaohei.im/css/custom-dark.css media="(prefers-color-scheme: dark)"><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://blog.xiaohei.im/js/main.js></script></head><body><div class="container wrapper post"><div class=header><h1 class=site-title><a href=https://blog.xiaohei.im/>xiaoheiAh's blog</a></h1><div class=site-description><h2>Java Developer | 日常逛逛v站, 刷 github</h2><nav class="nav social"><ul class=flat><a href=https://github.com/xiaoheiAh title=xiaoheiAh><i data-feather=github></i></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li><li><a href=/awesome>Awesome</a></li><li><a href=/cheatsheet>CheatSheet</a></li><li><a href=/about>About</a></li></ul></nav></div><div class=post-header><h1 class=title>Redis-RDB持久化</h1><div class=meta style=display:inline>Posted at &mdash; Nov 6, 2019</div><div class=meta style=display:inline><code>Page Views: 2</code></div></div><div class=markdown><p><code>redis</code> 为内存数据库,一旦服务器进程退出,服务器中的数据就不见了.所以内存中的数据需要持久化的硬盘中来保证可以在必要的时候进行故障恢复. <code>RDB</code> 就是 <code>redis</code> 提供的一种持久化方式.</p><blockquote><p>官方关于持久化的文章: <a href=https://redis.io/topics/persistence>https://redis.io/topics/persistence</a></p></blockquote><h2 id=什么是-rdb>什么是 RDB?</h2><p><code>RDB</code> 是 <code>redis</code> 提供的一种持久化方式,可以手动执行,也可以通过定时任务定期执行,可以将某个时间节点的数据库状态保存到一个 <code>RDB</code> 文件中,叫做 <code>dump.rdb</code>.如果开启了压缩算法( <code>LZF</code> )的支持,则可以利用算法减少文件大小.服务器意外宕机或者断电后重启都可以通过该文件来恢复数据库状态.</p><h3 id=如何执行>如何执行?</h3><p>有两个命令可以生成 <code>RDB</code> 文件.</p><ol><li><strong>SAVE:</strong> 执行时进程阻塞,无法处理其他命令</li><li><strong>BGSAVE:</strong> 新建一个子进程来后台生成 <code>RDB</code> 文件</li></ol><p>具体实现逻辑在: <code>src/rdb.c/rdbSave()</code>,从官方文档可知,该实现是基于 <code>cow</code> 的.</p><blockquote><p><a href=https://redis.io/topics/persistence>https://redis.io/topics/persistence</a></p><p>This method allows Redis to benefit from copy-on-write semantics.</p></blockquote><h3 id=如何载入>如何载入?</h3><p><code>RDB</code> 文件会在 <code>redis</code> 启动时自动载入.</p><p>由于 <code>AOF</code> 持久化的实时性更好,所以如果同时开启了 <code>AOF</code> , <code>RDB</code> 两种持久化,会优先使用 <code>AOF</code> 来恢复.</p><h3 id=bgsave-执行时的状态>BGSAVE 执行时的状态</h3><p><code>BGSAVE</code> 执行期间会拒绝 <code>SAVE/BGSAVE</code> 的命令,避免产生 <code>竞争条件</code>.</p><p><code>BGSAVE</code> 执行期间 <code>BGREWRITEAOF</code> 命令会延迟到 <code>BGSAVE</code> 执行完之后执行.</p><p><code>BGREWRITEAOF</code> 在执行时, <code>BGSAVE</code> 命令会被拒绝.</p><p><code>BGSAVE</code> 和 <code>BGREWRITEAOF</code> 命令的权衡完全是性能方面的考虑.毕竟都会有大量的磁盘写入,影响性能.</p><h2 id=定时执行bgsave>定时执行BGSAVE</h2><p><code>BGSAVE</code> 不会阻塞服务器进程,所以 <code>redis</code> 允许用户通过配置, 定时执行 <code>BGSAVE</code> 命令.</p><h3 id=快照策略-snapshotting>快照策略 Snapshotting</h3><p>可以通过设置 N 秒内至少 M 次修改来触发一次 <code>BGSAVE</code>.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>save <span style=color:#2aa198>60</span> <span style=color:#2aa198>1000</span> <span style=color:#586e75># 60s内有至少1000次修改时 bgsave 一次</span>
</code></pre></div><h4 id=默认的保存条件>默认的保存条件</h4><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>save <span style=color:#2aa198>900</span> <span style=color:#2aa198>1</span>
save <span style=color:#2aa198>300</span> <span style=color:#2aa198>10</span>
save <span style=color:#2aa198>60</span> <span style=color:#2aa198>10000</span>
</code></pre></div><h3 id=dirty-计数器--lastsave-属性>dirty 计数器 & lastsave 属性</h3><p><code>redis</code> 中维护了一个计数器,来记录距离上一次 <code>SAVE/BGSAVE</code> 后服务器对所有数据库进行了多少次增删改,叫做 <code>dirty计数器</code>.属于 <code>redisServer</code> 结构体的属性之一.</p><p><code>lastsave</code> 是记录了上一次成功执行 <code>SAVE/BGSAVE</code> 的 <code>UNIX时间戳</code> , 同样是 <code>redisServer</code> 结构体的属性之一.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#719e07># src/server.h
</span><span style=color:#719e07></span><span style=color:#719e07>struct</span> redisServer {
  ...
  <span style=color:#dc322f>long</span> <span style=color:#dc322f>long</span> dirty; <span style=color:#586e75>/* Changes to DB from the last save */</span>
  time_t lastsave; <span style=color:#586e75>/* Unix time of last successful save */</span>
  ...
}
</code></pre></div><h3 id=定时执行过程>定时执行过程</h3><p><code>redis</code> 有一个定时任务 <code>serverCron</code> , 每隔 <code>100ms</code> 就会执行一次,用于维护服务器.该任务就会检查 <code>save</code> 设置的保存条件是否满足,满足则执行 <code>BGSAVE</code></p><h4 id=满足条件逻辑>满足条件逻辑</h4><p>遍历设置的 <code>save</code> 参数, 计算当前时间到 <code>lastsave</code> 的间隔 <code>interval</code> , 如果 <code>dirty</code> > <code>save.change</code> & <code>interval</code> > <code>save.seconds</code> 那么就执行保存</p><h2 id=rdb-文件结构>RDB 文件结构</h2><blockquote><p><a href=https://github.com/sripathikrishnan/redis-rdb-tools/wiki/Redis-RDB-Dump-File-Format>https://github.com/sripathikrishnan/redis-rdb-tools/wiki/Redis-RDB-Dump-File-Format</a></p><p>写下这篇文章时参考版本为 2019.09.05 更新的版本</p></blockquote><p><code>RDB</code> 文件格式对读写进行了很多优化,这类优化导致其格式与内存中存在的形式极其相似,同时利用 <code>LZF</code> 压缩算法来优化文件的大小.一般来讲, <code>redis</code> 对象都会提前标记自身的大小,所以备份<code>RDB</code> 在读取这些 <code>object</code> 时,可以提前知道要分配多少内存.</p><h3 id=解析rdb结构>解析RDB结构</h3><p>下面的代码展示的是 16 进制下 <code>RDB</code> 文件的结构,便于理解</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>----------------------------# RDB is a binary format. There are no new lines or spaces in the file.
<span style=color:#2aa198>52</span> <span style=color:#2aa198>45</span> <span style=color:#2aa198>44</span> <span style=color:#2aa198>49</span> <span style=color:#2aa198>53</span>              <span style=color:#586e75># 魔数 REDIS的16进制表示,代表这是个RDB文件</span>
<span style=color:#2aa198>30</span> <span style=color:#2aa198>30</span> <span style=color:#2aa198>30</span> <span style=color:#2aa198>37</span>                 <span style=color:#586e75># 4位ascii码表示当前RDB版本号,这里表示&#34;0007&#34; = 7</span>
----------------------------
FE <span style=color:#2aa198>00</span>                       <span style=color:#586e75># FE 表明这是数据库选择标记. 00 表示选中0号数据库</span>
----------------------------# Key-Value pair starts
FD <span style=color:#268bd2>$unsigned</span> int            <span style=color:#586e75># FD 是秒级过期时间的标记. 紧接着是 4 byte unsigned int 过期时间</span>
<span style=color:#268bd2>$value</span>-type                 <span style=color:#586e75># 1 byte 标记 value 类型 - set, map, sorted set etc.</span>
<span style=color:#268bd2>$string</span>-encoded-key         <span style=color:#586e75># 经过编码后的键</span>
<span style=color:#268bd2>$encoded</span>-value              <span style=color:#586e75># 值,编码格式取决去 $value-type</span>
----------------------------
FC <span style=color:#268bd2>$unsigned</span> long           <span style=color:#586e75># FC 表明是毫秒级过期时间. 过期时间值是 8 bytes的 unsigned long,是一个unit时间戳</span>
<span style=color:#268bd2>$value</span>-type                 <span style=color:#586e75># 同上秒级时间</span>
<span style=color:#268bd2>$string</span>-encoded-key         <span style=color:#586e75># 同上秒级时间</span>
<span style=color:#268bd2>$encoded</span>-value              <span style=color:#586e75># 同上秒级时间</span>
----------------------------
<span style=color:#268bd2>$value</span>-type                 <span style=color:#586e75># 这一栏是没有过期时间的key-value</span>
<span style=color:#268bd2>$string</span>-encoded-key
<span style=color:#268bd2>$encoded</span>-value
----------------------------
FE <span style=color:#268bd2>$length</span>-encoding         <span style=color:#586e75># 前一个数据库的编码完成,选择新的数据库进行处理.数据库编号会根据 length-encoding 格式获得</span>
----------------------------
...                         <span style=color:#586e75># Key value pairs for this database, additonal database</span>
                            
FF                          <span style=color:#586e75>## 表明 RDB 文件结束了</span> 
<span style=color:#2aa198>8</span> byte checksum             <span style=color:#586e75>## 8byte CRC 64 校验码</span>
</code></pre></div><h4 id=value-type>value type</h4><p>1 byte 表示了 <code>value</code> 的类型.</p><table><thead><tr><th>type(以下为十进制表示)</th><th>编码类型</th></tr></thead><tbody><tr><td>0</td><td>String</td></tr><tr><td>1</td><td>List</td></tr><tr><td>2</td><td>Set</td></tr><tr><td>3</td><td>Sorted Set</td></tr><tr><td>4</td><td>Hash</td></tr><tr><td>9</td><td>Zipmap</td></tr><tr><td>10</td><td>Ziplist</td></tr><tr><td>11</td><td>Intset</td></tr><tr><td>12</td><td>Sorted Set in Ziplist</td></tr><tr><td>13</td><td>HashMap in Ziplist</td></tr></tbody></table><h4 id=键值编码格式>键值编码格式</h4><p>键(<code>key</code>)都是字符串,所以使用<code>string</code> 编码格式.</p><p>值(<code>value</code>)就会有不同的区分:</p><ul><li>如果 <code>value type</code> 为 0 ,会是简单的字符串.</li><li>如果 <code>value type</code> 为 9,10,11,12, 值会被包装为 <code>string</code>, 在读到该字符串后,会进一步解析.</li><li>如果 <code>value type</code> 为 1,2,3,4, 值会是一个字符串数组.</li></ul><h3 id=length-encoding>Length Encoding</h3><p>长度编码是用来存储对象的长度的.是一种可变字节码,旨在使用尽可能少的字节.</p><h4 id=如何工作>如何工作?</h4><ol><li>从流中读取 1byte,得到高两位.</li><li>如果是 <code>00</code> 开头, 那么剩下 6 位表示长度</li><li>如果是 <code>01</code> 开头, 会再从流中读取 1byte,合起来总共 14 位作为长度.</li><li>如果是 <code>10</code> 开头, 会直接丢弃剩下的 6 位.再从流中读取 4bytes作为长度.</li><li>如果是 <code>11</code> 开头, 说明这个对象是一种特殊编码格式. 剩下的 6 位表示了它的格式类型.这个编码通常用来将数字存储为字符串,或者存储被编码过得字符串(<a href=#String-Encoding>String Encoding</a>).</li></ol><h4 id=编码结果是>编码结果是?</h4><p>从上述可得,可能的编码格式是这样的:</p><ol><li>1 byte 最多存储到 63</li><li>2 bytes 最多存储到 16383</li><li>5 bytes 最多存储到 2^32 - 1</li></ol><h3 id=string-encoding>String Encoding</h3><p><code>redis</code> 的字符串是二进制安全的,所以可以存储 anything. 没有任何字符串结尾的标记.最好将 <code>redis</code> 字符串视为一个字节数组.</p><p>有三种类型的字符串:</p><ol><li><p>长度编码字符串</p><p>这是最简单的一种,字符串的长度会利用 <code>Length Encoding</code> 编码作为前缀,后面跟着字符串的编码</p></li><li><p>数字作为字符串</p><p>这里就将上面 <a href=#Length-Encoding>Length Encoding</a> 的特殊编码格式联系起来了,数字作为字符串时以 <code>11</code> 开头,剩下的 6 位表示不同的数字类型</p><ul><li>0 表示接下来是一个 8 位数字</li><li>1 表示接下来是一个 16 位数字</li><li>2 表示接下来是一个 32 位数字</li></ul></li><li><p>压缩字符串</p><p>压缩字符串的 <code>Length Encoding</code> 还是以 <code>11</code> 开头的, 但是剩下的6 位二进制的值为 4, 表明后面读取到的是一个压缩字符串.压缩字符串会存储压缩前和压缩后的长度.解析规则如下:</p><ul><li>根据 <code>Length Encoding</code> 读取压缩的长度 <code>clen</code></li><li>根据 <code>Length Encoding</code> 读取未压缩的长度</li><li>从流中读取 <code>clen</code> bytes 的数据</li><li>利用 <code>LZF</code> 算法进行解析</li></ul></li></ol><h2 id=分析rdb文件>分析RDB文件</h2><p>利用 <code>od</code> 命令来分析来看看 <code>rdb</code> 文件长什么样子.我将 <code>redis</code> 数据库清空后,执行了 <code>set msg hello</code>,所以现在只有一个键 <code>msg</code>, 值为 <code>hello</code>.下面的命令第一行输出的是 16 进制,下面一行输出的是对应的 <code>ascii</code>. 下面进行解析~</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>➜ od -A x -t x1c -v dump.rdb
<span style=color:#2aa198>0000000</span>    <span style=color:#2aa198>52</span>  <span style=color:#2aa198>45</span>  <span style=color:#2aa198>44</span>  <span style=color:#2aa198>49</span>  <span style=color:#2aa198>53</span>  <span style=color:#2aa198>30</span>  <span style=color:#2aa198>30</span>  <span style=color:#2aa198>30</span>  <span style=color:#2aa198>39</span>  fa  <span style=color:#2aa198>09</span>  <span style=color:#2aa198>72</span>  <span style=color:#2aa198>65</span>  <span style=color:#2aa198>64</span>  <span style=color:#2aa198>69</span>  <span style=color:#2aa198>73</span>
           R   E   D   I   S   <span style=color:#2aa198>0</span>   <span style=color:#2aa198>0</span>   <span style=color:#2aa198>0</span>   <span style=color:#2aa198>9</span> <span style=color:#2aa198>372</span>  <span style=color:#cb4b16>\t</span>   r   e   d   i   s
<span style=color:#2aa198>0000010</span>    2d  <span style=color:#2aa198>76</span>  <span style=color:#2aa198>65</span>  <span style=color:#2aa198>72</span>  <span style=color:#2aa198>05</span>  <span style=color:#2aa198>35</span>  2e  <span style=color:#2aa198>30</span>  2e  <span style=color:#2aa198>34</span>  fa  0a  <span style=color:#2aa198>72</span>  <span style=color:#2aa198>65</span>  <span style=color:#2aa198>64</span>  <span style=color:#2aa198>69</span>
           -   v   e   r <span style=color:#2aa198>005</span>   <span style=color:#2aa198>5</span>   .   <span style=color:#2aa198>0</span>   .   <span style=color:#2aa198>4</span> <span style=color:#2aa198>372</span>  <span style=color:#cb4b16>\n</span>   r   e   d   i
<span style=color:#2aa198>0000020</span>    <span style=color:#2aa198>73</span>  2d  <span style=color:#2aa198>62</span>  <span style=color:#2aa198>69</span>  <span style=color:#2aa198>74</span>  <span style=color:#2aa198>73</span>  c0  <span style=color:#2aa198>40</span>  fa  <span style=color:#2aa198>05</span>  <span style=color:#2aa198>63</span>  <span style=color:#2aa198>74</span>  <span style=color:#2aa198>69</span>  6d  <span style=color:#2aa198>65</span>  c2
           s   -   b   i   t   s <span style=color:#2aa198>300</span>   @ <span style=color:#2aa198>372</span> <span style=color:#2aa198>005</span>   c   t   i   m   e <span style=color:#2aa198>051</span>
<span style=color:#2aa198>0000030</span>    <span style=color:#2aa198>29</span>  e8  c3  5d  fa  <span style=color:#2aa198>08</span>  <span style=color:#2aa198>75</span>  <span style=color:#2aa198>73</span>  <span style=color:#2aa198>65</span>  <span style=color:#2aa198>64</span>  2d  6d  <span style=color:#2aa198>65</span>  6d  c2  d0
           <span style=color:#719e07>)</span> <span style=color:#2aa198>350</span> <span style=color:#2aa198>303</span>   <span style=color:#719e07>]</span> <span style=color:#2aa198>372</span>  <span style=color:#cb4b16>\b</span>   u   s   e   d   -   m   e   m <span style=color:#2aa198>302</span> <span style=color:#2aa198>007</span>
<span style=color:#2aa198>0000040</span>    <span style=color:#2aa198>07</span>  <span style=color:#2aa198>10</span>  <span style=color:#2aa198>00</span>  fa  0c  <span style=color:#2aa198>61</span>  6f  <span style=color:#2aa198>66</span>  2d  <span style=color:#2aa198>70</span>  <span style=color:#2aa198>72</span>  <span style=color:#2aa198>65</span>  <span style=color:#2aa198>61</span>  6d  <span style=color:#2aa198>62</span>  6c
          <span style=color:#cb4b16>\a</span> <span style=color:#2aa198>020</span>  <span style=color:#cb4b16>\0</span> <span style=color:#2aa198>372</span>  <span style=color:#cb4b16>\f</span>   a   o   f   -   p   r   e   a   m   b   l
<span style=color:#2aa198>0000050</span>    <span style=color:#2aa198>65</span>  c0  <span style=color:#2aa198>00</span>  fe  <span style=color:#2aa198>00</span>  fb  <span style=color:#2aa198>01</span>  <span style=color:#2aa198>00</span>  <span style=color:#2aa198>00</span>  <span style=color:#2aa198>03</span>  6d  <span style=color:#2aa198>73</span>  <span style=color:#2aa198>67</span>  <span style=color:#2aa198>05</span>  <span style=color:#2aa198>68</span>  <span style=color:#2aa198>65</span>
           e <span style=color:#2aa198>300</span>  <span style=color:#cb4b16>\0</span> <span style=color:#2aa198>376</span>  <span style=color:#cb4b16>\0</span> <span style=color:#2aa198>373</span> <span style=color:#2aa198>001</span>  <span style=color:#cb4b16>\0</span>  <span style=color:#cb4b16>\0</span> <span style=color:#2aa198>003</span>   m   s   g <span style=color:#2aa198>005</span>   h   e
<span style=color:#2aa198>0000060</span>    6c  6c  6f  ff  <span style=color:#b58900>fc</span>  0e  6b  <span style=color:#2aa198>79</span>  fe  <span style=color:#2aa198>47</span>  1a  <span style=color:#2aa198>36</span>
           l   l   o <span style=color:#2aa198>377</span> <span style=color:#2aa198>374</span> <span style=color:#2aa198>016</span>   k   y <span style=color:#2aa198>376</span>   G <span style=color:#2aa198>032</span>   <span style=color:#2aa198>6</span>
000006c
</code></pre></div><h3 id=魔数和版本号>魔数和版本号</h3><p>前 5 个字节就是我们看到的 <code>REDIS</code>,以及后四个字节对应的版本号<code>9</code></p><h3 id=辅助字段-aux-fields>辅助字段 Aux Fields</h3><p>这是 <code>Version 7</code> 之后加入的字段, <code>Redis设计与实现</code> 所使用的版本是没有这个,所以一开始有点懵~ 只能看代码了.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#719e07># src/rdb.c
</span><span style=color:#719e07></span><span style=color:#586e75>/* 该函数负责执行 RDB 文件的写入 */</span>
<span style=color:#dc322f>int</span> <span style=color:#268bd2>rdbSave</span>(<span style=color:#dc322f>char</span> <span style=color:#719e07>*</span>filename, rdbSaveInfo <span style=color:#719e07>*</span>rsi) {
	<span style=color:#586e75>//伪代码
</span><span style=color:#586e75></span>  <span style=color:#2aa198>1.</span> 创建一个临时文件 temp<span style=color:#719e07>-</span>$pid.rdb,并处理创建失败的逻辑
  <span style=color:#2aa198>2.</span> 新建一个redis封装的I<span style=color:#719e07>/</span>O流
  <span style=color:#2aa198>3.</span> 写入rdb文件 rdbSaveRio()
  <span style=color:#2aa198>4.</span> 将文件重命名, 默认重命名为 dump.rdb
  <span style=color:#2aa198>5.</span> 更新服务器的一些状态<span style=color:#719e07>:</span> dirty计数器置0,更新lastsave等
}
</code></pre></div><p>然后我们来看下写入的 <code>Aux Fields</code>, 在函数 <code>rdbSaveRio</code> 中</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#dc322f>int</span> <span style=color:#268bd2>rdbSaveRio</span>(rio <span style=color:#719e07>*</span>rdb, <span style=color:#dc322f>int</span> <span style=color:#719e07>*</span>error, <span style=color:#dc322f>int</span> flags, rdbSaveInfo <span style=color:#719e07>*</span>rsi) {
	 <span style=color:#586e75>// 忽略所有只看重点
</span><span style=color:#586e75></span>   <span style=color:#719e07>if</span> (server.rdb_checksum)
        rdb<span style=color:#719e07>-&gt;</span>update_cksum <span style=color:#719e07>=</span> rioGenericUpdateChecksum; <span style=color:#586e75>// 生成校验码
</span><span style=color:#586e75></span>    snprintf(magic,<span style=color:#719e07>sizeof</span>(magic),<span style=color:#2aa198>&#34;REDIS%04d&#34;</span>,RDB_VERSION); <span style=color:#586e75>// 生成魔数及版本号
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> (rdbWriteRaw(rdb,magic,<span style=color:#2aa198>9</span>) <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>goto</span> werr; <span style=color:#586e75>// 写入魔数及版本号
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> (rdbSaveInfoAuxFields(rdb,flags,rsi) <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>goto</span> werr; <span style=color:#586e75>// 写入 AuxFileds
</span><span style=color:#586e75></span>}

<span style=color:#586e75>/* Save a few default AUX fields with information about the RDB generated. */</span>
<span style=color:#dc322f>int</span> <span style=color:#268bd2>rdbSaveInfoAuxFields</span>(rio <span style=color:#719e07>*</span>rdb, <span style=color:#dc322f>int</span> flags, rdbSaveInfo <span style=color:#719e07>*</span>rsi) {
    <span style=color:#dc322f>int</span> redis_bits <span style=color:#719e07>=</span> (<span style=color:#719e07>sizeof</span>(<span style=color:#dc322f>void</span><span style=color:#719e07>*</span>) <span style=color:#719e07>==</span> <span style=color:#2aa198>8</span>) <span style=color:#719e07>?</span> <span style=color:#2aa198>64</span> <span style=color:#719e07>:</span> <span style=color:#2aa198>32</span>;
    <span style=color:#dc322f>int</span> aof_preamble <span style=color:#719e07>=</span> (flags <span style=color:#719e07>&amp;</span> RDB_SAVE_AOF_PREAMBLE) <span style=color:#719e07>!=</span> <span style=color:#2aa198>0</span>;

    <span style=color:#586e75>/* Add a few fields about the state when the RDB was created. */</span>
    <span style=color:#719e07>if</span> (rdbSaveAuxFieldStrStr(rdb,<span style=color:#2aa198>&#34;redis-ver&#34;</span>,REDIS_VERSION) <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>return</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>;
    <span style=color:#719e07>if</span> (rdbSaveAuxFieldStrInt(rdb,<span style=color:#2aa198>&#34;redis-bits&#34;</span>,redis_bits) <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>return</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>;
    <span style=color:#719e07>if</span> (rdbSaveAuxFieldStrInt(rdb,<span style=color:#2aa198>&#34;ctime&#34;</span>,time(<span style=color:#b58900>NULL</span>)) <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>return</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>;
    <span style=color:#719e07>if</span> (rdbSaveAuxFieldStrInt(rdb,<span style=color:#2aa198>&#34;used-mem&#34;</span>,zmalloc_used_memory()) <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>return</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>;

    <span style=color:#586e75>/* Handle saving options that generate aux fields. */</span>
    <span style=color:#719e07>if</span> (rsi) {
        <span style=color:#719e07>if</span> (rdbSaveAuxFieldStrInt(rdb,<span style=color:#2aa198>&#34;repl-stream-db&#34;</span>,rsi<span style=color:#719e07>-&gt;</span>repl_stream_db)
            <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>return</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>;
        <span style=color:#719e07>if</span> (rdbSaveAuxFieldStrStr(rdb,<span style=color:#2aa198>&#34;repl-id&#34;</span>,server.replid)
            <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>return</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>;
        <span style=color:#719e07>if</span> (rdbSaveAuxFieldStrInt(rdb,<span style=color:#2aa198>&#34;repl-offset&#34;</span>,server.master_repl_offset)
            <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>return</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>;
    }
    <span style=color:#719e07>if</span> (rdbSaveAuxFieldStrInt(rdb,<span style=color:#2aa198>&#34;aof-preamble&#34;</span>,aof_preamble) <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>return</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>;
    <span style=color:#719e07>return</span> <span style=color:#2aa198>1</span>;
}
</code></pre></div><p>以上可以看出会写入这些字段.</p><ul><li><p><code>redis-ver</code>：版本号</p></li><li><p><code>redis-bits</code>：OS 操作系统位数 32/64</p></li><li><p><code>ctime</code>：RDB文件创建时间</p></li><li><p><code>used-mem</code>：使用内存大小</p></li><li><p><code>repl-stream-db</code>：在server.master客户端中选择的数据库</p></li><li><p><code>repl-id</code>：当前实例 replication ID</p></li><li><p><code>repl-offset</code>：当前实例复制的偏移量</p></li></ul><p>每一个属性写入前都会写入 <code>0XFA</code>, 标记这是一个辅助字段.在上面命令行输出中,<code>ascii</code> 展示为 <code>372</code></p><h3 id=数据库相关标记>数据库相关标记</h3><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#2aa198>0000050</span>    <span style=color:#2aa198>65</span>  c0  <span style=color:#2aa198>00</span>  fe  <span style=color:#2aa198>00</span>  fb  <span style=color:#2aa198>01</span>  <span style=color:#2aa198>00</span>  <span style=color:#2aa198>00</span>  <span style=color:#2aa198>03</span>  6d  <span style=color:#2aa198>73</span>  <span style=color:#2aa198>67</span>  <span style=color:#2aa198>05</span>  <span style=color:#2aa198>68</span>  <span style=color:#2aa198>65</span>
           e <span style=color:#2aa198>300</span>  <span style=color:#cb4b16>\0</span> <span style=color:#2aa198>376</span>  <span style=color:#cb4b16>\0</span> <span style=color:#2aa198>373</span> <span style=color:#2aa198>001</span>  <span style=color:#cb4b16>\0</span>  <span style=color:#cb4b16>\0</span> <span style=color:#2aa198>003</span>   m   s   g <span style=color:#2aa198>005</span>   h   e
</code></pre></div><p>这一行中的 <code>0XFE</code> 表示选择数据库,后面紧接着 <code>00</code> 即为,选择 0 号数据库. <code>0XFB</code> 是标记了当前数据库中键存储的数量,这里用到了 <code>Length Encoding</code>, <code>01</code> 是我们存储的字典中<code>key-value</code>的数量,<code>00</code> 是过期字典(<code>expires</code>)中的数量.</p><blockquote><p>redisDB中有两个属性, <code>dict</code> 记录了我们写入的所有键, <code>expires</code> 存储了我们设置有过期时间的键以及其过期时间.</p></blockquote><h3 id=key-value-结构>Key Value 结构</h3><p>我们设置了 <code>msg</code> -> <code>hello</code>,在输出中是这样的.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#2aa198>0000050</span>    <span style=color:#2aa198>65</span>  c0  <span style=color:#2aa198>00</span>  fe  <span style=color:#2aa198>00</span>  fb  <span style=color:#2aa198>01</span>  <span style=color:#2aa198>00</span>  <span style=color:#2aa198>00</span>  <span style=color:#2aa198>03</span>  6d  <span style=color:#2aa198>73</span>  <span style=color:#2aa198>67</span>  <span style=color:#2aa198>05</span>  <span style=color:#2aa198>68</span>  <span style=color:#2aa198>65</span>
           e <span style=color:#2aa198>300</span>  <span style=color:#cb4b16>\0</span> <span style=color:#2aa198>376</span>  <span style=color:#cb4b16>\0</span> <span style=color:#2aa198>373</span> <span style=color:#2aa198>001</span>  <span style=color:#cb4b16>\0</span>  <span style=color:#cb4b16>\0</span> <span style=color:#2aa198>003</span>   m   s   g <span style=color:#2aa198>005</span>   h   e
</code></pre></div><p>在 <code>msg</code> 前面的字段 <code>\0 003</code>, 表示他是 <code>string</code> 类型, 且长度为 <code>3</code>, <code>005 hello</code>, 表示是长度为 <code>5</code> 的 <code>hello</code>.</p><p>还有其他数据结构这里就不做展示了.</p><h3 id=结束符--校验码>结束符 & 校验码</h3><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#2aa198>0000060</span>    6c  6c  6f  ff  <span style=color:#b58900>fc</span>  0e  6b  <span style=color:#2aa198>79</span>  fe  <span style=color:#2aa198>47</span>  1a  <span style=color:#2aa198>36</span>
           l   l   o <span style=color:#2aa198>377</span> <span style=color:#2aa198>374</span> <span style=color:#2aa198>016</span>   k   y <span style=color:#2aa198>376</span>   G <span style=color:#2aa198>032</span>   <span style=color:#2aa198>6</span>
</code></pre></div><p>最后一行输出中 <code>0xff</code> , 文件结束符, 剩下的八个字节就是 <code>CRC64</code></p><h2 id=参考>参考</h2><ol><li><p><a href=https://cloud.tencent.com/developer/article/1179710>https://cloud.tencent.com/developer/article/1179710</a></p></li><li><p><a href=https://juejin.im/post/5d8dc285f265da5b9e0d3089>Redis5.0 RDB文件解析</a></p></li></ol></div><div class=post-tags><nav class="nav tags"><ul class=flat><li><a href=/tags/redis>redis</a></li></ul></nav></div><script src=https://utteranc.es/client.js repo=xiaoheiAh/xiaoheiAh.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div><div class="footer wrapper"><nav class=nav><div>© Copyright notice | <a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-98254666-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></body></html>