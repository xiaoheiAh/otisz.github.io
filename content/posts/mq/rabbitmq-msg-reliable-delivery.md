---
title: "RabbitMQ-可用性指南"
date: 2019-09-21T18:42:13+08:00
draft: true
categories: ["消息队列"]
description: "「RabbitMQ 学习笔记」| RabbitMQ可用性指南"
tags : ["rabbitmq"]
---

消息的可靠性是需要 `Producer`, `Consumer`, `RabbitMQ Nodes` 来共同保证的.

### 导致失败的原因

1. 网络连接或者拥堵问题/防火墙中断空闲连接等
2. 硬件崩溃/软件的逻辑错误
3. 性能下降/恶意地或者bug极多耗尽系统资源等.

### 消息确认机制

连接断开时,消息可能还在 `Producer` 与 `Broker`, `Consumer` 与 `Broker` 任意一端直接传输,此时这些消息需要能在连接恢复后重新传输,消息确认机制便是实现的一种方式.

消息确认机制在 `Consumer ` 端用于通知 `Broker` 已经收到消息,或者 `Broker` 收到 `Producer` 消息后返回的确认. `Consumer` 端叫做 `ack`, `Producer` 端叫做 `confirm`.

尽管 `TCP` 会保证 `packets` 发送到对方, 并处理失败再重传, 但这只是网络层. 消息确认机制保证的是应用间的可靠传递.

消息确认机制的语义: 消费方应该在对消息做出处理后(例如,存储,传递,执行其他操作)再 `ack` 消息. 此时 `broker` 就可以标记删除该消息了.

使用 **消息确认机制**可以保证 `at least once` 的语义, 没有该机制可能会丢失消息, 只能保证 `at most once`的语义.

### 心跳检测不可用连接

在有些类型的网络错误中,数据包的丢失意味着操作系统需要花费较长的时间来检测 `TCP` 的连接中断( `Linux` 中默认是 `11` 分钟).  `AMQP-0-9-1` 提供了心跳的特性来保证应用层的连接中断. 心跳还可以解决网络设备中断空闲连接的问题.

### Broker端的数据安全

`Exchanges`, `Queues` , `Messages` 都有提供持久化, 来保证宕机后也可以正常恢复.

### 集群与消息副本

集群模式可以防止单节点故障. `Exchanges`, `Bindings`, `Users` 都可以在集群中创建副本. `Queues` 有些许不同, 默认情况下, `Queue` 只会存储在单个节点上, 但可以配置在集群中冗余副本, 但该冗余是全量的, 所有节点都可以访问,不用在意主节点是哪一个.



### Producer端的数据安全

#### 保证数据已路由

### Consumer端的数据安全

### 无法处理的发送

### 监控及健康检查